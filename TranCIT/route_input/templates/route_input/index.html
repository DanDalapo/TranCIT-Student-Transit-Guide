{# --- START OF FILE route_input/templates/route_input/index.html --- #}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TranCIT Prototype</title>
  <link rel="stylesheet" href="{% static 'route_input/css/styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  {# Folium's CSS will be injected by Django's {{ map|safe }} #}
  {# NEW: Add a small style for the suggestions container for now #}
  <style>
    .destination-input-group { /* MODIFIED: This group now primarily handles the input and suggestions */
        position: relative; /* Needed for absolute positioning of suggestions */
    }
    .destination-input-group .form-control {
        width: 100%; /* Ensure input takes full width */
    }
    .destination-suggestions {
        position: absolute;
        background-color: #333; /* Dark background */
        border: 1px solid #555;
        max-height: 200px;
        overflow-y: auto;
        width: calc(100% - 2px); /* Match input width minus border */
        left: 0; /* Align with the start of the input */
        top: 100%; /* Position below the input */
        z-index: 1000; /* Ensure it appears above other elements */
        color: #eee;
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }
    .destination-suggestions-item {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #444;
    }
    .destination-suggestions-item:hover {
        background-color: #555;
    }
    .destination-suggestions-item:last-child {
        border-bottom: none;
    }
    /* NEW: Style for the search button below the destination input */
    #searchDestinationBtn {
        width: 100%; /* Make it full width */
        margin-top: 5px; /* Add some space above it */
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }
  </style>
</head>
<body>

  <div class="topNav">
    <ul>
      <li>
        <a href="#logo_place_holder" class="active">
          <img src="{% static 'route_input/images/TranCIT_logo.svg' %}" alt="TranCIT Logo">
        </a>
      </li>
      <input type="text" placeholder="Search..">
    </ul>
  </div>

  <div class="container">

    <!-- Left Panel (for Adding New Routes) -->
    <aside class="sidebar">
      <h3>Add New Route</h3>
        <form id="routeForm" method="post" novalidate>
          {% csrf_token %}

          {# Removed Jeepney Code dropdown from this form as per instruction #}

          <label for="{{ form.origin.id_for_label }}">Current Location</label>
          <input type="text" name="{{ form.origin.name }}" id="{{ form.origin.id_for_label }}"
                 placeholder="{{ form.origin.field.widget.attrs.placeholder }}"
                 value="{{ get_origin_text|default_if_none:form.origin.value }}"
                 {% if form.origin.field.required %}required{% endif %}
                 class="form-control">
          <button type="button" id="detectLocationBtn" class="btn btn-sm">Detect My Location</button>
          <span class="error" id="error-origin">
            {% if form.origin.errors %}{{ form.origin.errors }}{% endif %}
          </span>

          <label for="{{ form.destination.id_for_label }}">Destination (Text)</label>
          <div class="destination-input-group"> {# Wrapper for input and suggestions #}
            {{ form.destination }}
            <div id="destinationSuggestions" class="destination-suggestions" style="display: none;"></div>
          </div>
          <button type="button" id="searchDestinationBtn" class="btn btn-sm">Search</button> {# MOVED: Search button #}

          <label for="{{ form.destination.id_for_label }}">Destination</label>
          {{ form.destination }}

          <span class="error" id="error-destination">
            {% if form.destination.errors %}{{ form.destination.errors }}{% endif %}
          </span>

          <label for="{{ form.transport_type.id_for_label }}">Transportation Type</label>
          {{ form.transport_type }}
          <span class="error" id="error-transport-type">
            {% if form.transport_type.errors %}{{ form.transport_type.errors }}{% endif %}
          </span>

          <div id="fareDisplay" style="margin-top: 10px;">
            <label>Estimated Fare:</label>
            <p id="calculatedFare">Php 0.00</p>
          </div>

          {# Hidden fields for backend calculation and saving #}
          <input type="hidden" name="{{ form.fare.name }}" id="id_fare" value="{{ form.fare.value|default:'0.00' }}">
          <input type="hidden" name="{{ form.distance_km.name }}" id="id_distance_km" value="{{ form.distance_km.value|default:'' }}">
          <input type="hidden" name="{{ form.travel_time_minutes.name }}" id="id_travel_time_minutes" value="{{ form.travel_time_minutes.value|default:'' }}">
          <input type="hidden" name="{{ form.origin_latitude.name }}" id="id_origin_latitude" value="{{ form.origin_latitude.value|default:'' }}">
          <input type="hidden" name="{{ form.origin_longitude.name }}" id="id_origin_longitude" value="{{ form.origin_longitude.value|default:'' }}">
          <input type="hidden" name="{{ form.destination_latitude.name }}" id="id_destination_latitude" value="{{ form.destination_latitude.value|default:'' }}">
          <input type="hidden" name="{{ form.destination_longitude.name }}" id="id_destination_longitude" value="{{ form.destination_longitude.value|default:'' }}">
          <input type="hidden" name="{{ form.code.name }}" id="id_code" value="{{ form.code.value|default:'' }}"> {# Hidden code field #}


          <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
          {{ form.notes }}
          <span class="error" id="error-notes">
            {% if form.notes.errors %}{{ form.notes.errors }}{% endif %}
          </span>

          {# Server-side success/error messages #}
          {% if success_message %}
            <p class="success-message">{{ success_message }}</p>
          {% endif %}
          {% if error_message %}
            <p class="error-message">{{ error_message }}</p>
          {% endif %}

          <button type="submit" class="btn primary">Add New Route</button>
        </form>

      <div class="saved-locations">
        <h4>Saved Locations (for User's frequently used routes)</h4>
        <ul id="savedList"></ul>
      </div>
    </aside>

    <!-- Map Area -->
    <main class="map-area">
      <div id="map-container">
        {{ map|safe }}
      </div>
    </main>


    <aside class="suggestions">
      <h3>Jeepney Suggestions</h3>
      {# Search Form for Suggestions #}
      <form id="suggestionSearchForm" method="get" action="{% url 'routes_page' %}">
        <label for="{{ form.origin.id_for_label }}">Current Location</label>
        <input type="text" name="origin_search" placeholder="Search Origin..." value="{{ search_origin|default_if_none:'' }}" class="form-control">
        <label for="{{ form.destination.id_for_label }}">Destination</label>
        <input type="text" name="destination_search" placeholder="Search Destination..." value="{{ search_destination|default_if_none:'' }}" class="form-control">
        
        <label for="{{ form.transport_type.id_for_label }}">Transportation Type</label>
        <select name="transport_type_search" id="id_transport_type_search" class="form-control">
            <option value="">All Types</option>
            {% for choice_value, choice_label in form.transport_type.field.choices %}
                <option value="{{ choice_value }}" {% if search_transport_type == choice_value %}selected{% endif %}>{{ choice_label }}</option>
            {% endfor %}
        </select>
        <select name="jeepney_code_search" id="id_jeepney_code_search" class="form-control"> {# NEW Jeepney Code Search #}
            <option value="">All Jeepney Codes</option>
            {% for code_value, code_label in form.code.field.choices %}
                <option value="{{ code_value }}" {% if search_jeepney_code == code_value %}selected{% endif %}>{{ choice_label }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn primary">Search</button>
      </form>
      <hr>

      <div id="dynamicSuggestions">
        {% if all_routes %}
          {% for route in all_routes %}
            {# MODIFIED: Add 'highlighted-route' class if this route's ID matches the highlight_route_id from context #}
            <div class="journey-card {% if route.id|stringformat:"s" == highlight_route_id %}highlighted-route{% endif %}">
                <div class="journey-header">
                    <div class="journey-route-summary">
                        <span class="segment {% if route.transport_type == 'Jeepney' %}jeepney-segment{% else %}other-segment{% endif %}">
                            {% if route.transport_type == 'Jeepney' %}
                                <i class="fa-solid fa-bus"></i> {{ route.code|default:'N/A' }}
                            {% elif route.transport_type == 'Taxi' %}
                                <i class="fa-solid fa-car"></i> Taxi
                            {% elif route.transport_type == 'Motorcycle' %}
                                <i class="fa-solid fa-motorcycle"></i> Motorcycle
                            {% else %}
                                <i class="fa-solid fa-info-circle"></i> {{ route.transport_type }}
                            {% endif %}
                        </span>
                    </div>
                    <div class="journey-time">
                        {% if route.travel_time_minutes %}{{ route.travel_time_minutes|floatformat:0 }} min{% else %}N/A{% endif %}
                    </div>
                </div>
                <div class="journey-details">
                    <p class="journey-schedule">From: {{ route.origin }}</p>
                    <p class="journey-schedule">To: {{ route.destination }}</p>
                    <p class="journey-fare">Est. Fare: Php {{ route.fare|floatformat:2 }}</p>
                    {% if route.distance_km %} <p class="journey-distance">{{ route.distance_km|floatformat:1 }} km</p> {% endif %}
                </div>
                <button type="button" class="btn btn-sm view-journey-on-map-btn"
                        data-route-id="{{ route.id }}" {# NEW: Pass the route ID #}
                        data-origin-lat="{{ route.origin_latitude }}"
                        data-origin-lon="{{ route.origin_longitude }}"
                        data-dest-lat="{{ route.destination_latitude }}"
                        data-dest-lon="{{ route.destination_longitude }}"
                        data-route-code="{{ route.code }}"
                        data-transport-type="{{ route.transport_type }}"
                        data-route-origin="{{ route.origin }}"
                        data-route-destination="{{ route.destination }}">
                    View on Map
                </button>
            </div>
          {% endfor %}
        {% else %}
          <div class="journey-card"><p>No suggested routes found for your search.</p></div>
        {% endif %}
      </div>

      <textarea placeholder="Write your own general suggestion"></textarea>
      <button type="button" class="btn">Submit General Suggestion</button>
    </aside>

  </div>

  <script src="{% static 'route_input/js/script.js' %}"></script>
</body>
</html>
{# --- END OF FILE route_input/templates/route_input/index.html --- #}