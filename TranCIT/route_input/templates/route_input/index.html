{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TranCIT</title>
  <link rel="stylesheet" href="{% static 'route_input/css/styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

  <div class="topNav">
    <a href="{% url 'routes_page' %}" class="logo">üöç TranCIT</a>
    
    <div class="search-box">
      <input type="text" placeholder="Search..">
    </div>
    
    <div class="nav-actions">
      
      <a href="{% url 'toggle_newbie_mode' %}" class="nav-btn" 
         style="background-color: #ffc107; color: #333;">
        Newbie Mode
      </a>
      
      {% if user.is_authenticated %}
        <a href="{% url 'logout' %}" class="nav-btn" 
           style="background-color: #dc3545;">
          Log out
        </a>
      {% else %}
        <a href="{% url 'login_registration:login' %}" class="nav-btn" 
           style="background-color: #6c757d;">
          Exit Guest
        </a>
      {% endif %}
      
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <h3>Plan Your Route</h3>
      
      <form id="routeForm" method="post" action="{% url 'plan_route' %}" novalidate>
        {% csrf_token %}
        <input type="hidden" name="form_type" value="plan_route">

        <label for="{{ form.origin.id_for_label }}">Current Location</label>
        <input type="text" name="{{ form.origin.name }}" id="{{ form.origin.id_for_label }}"
               placeholder="Your current location"
               value="{{ get_origin_text|default_if_none:form.origin.value }}"
               {% if form.origin.field.required %}required{% endif %}
               class="form-control">

        <div class="pin-controls" style="margin-top: 5px;">
          <button type="button" id="pinOriginBtn" class="btn btn-sm">
            <i class="fa-solid fa-map-pin"></i> Pin Origin on Map
          </button>
          <!-- <button type="button" id="pinDestinationBtn" class="btn btn-sm">
            <i class="fa-solid fa-map-pin"></i> Pin Destination on Map
          </button> -->
        </div>

        <div class="divider">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  or  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
        <button type="button" id="detectLocationBtn" class="btn btn-sm">
          <i class="fa-solid fa-location-crosshairs"></i> Detect My Location
        </button>
        
        <span class="error" id="error-origin">
          {% if form.origin.errors %}{{ form.origin.errors }}{% endif %}
        </span>

        <label for="{{ form.destination.id_for_label }}">Where do you want to go?</label>
        <div class="destination-input-group">
          <input type="text" name="{{ form.destination.name }}" id="{{ form.destination.id_for_label }}"
                 placeholder="Enter your destination"
                 value="{{ get_destination_text|default_if_none:form.destination.value }}"
                 {% if form.destination.field.required %}required{% endif %}
                 class="form-control">
          <button type="button" id="pinDestinationBtn" class="btn btn-sm">
            <i class="fa-solid fa-map-pin"></i> Pin Destination on Map
          </button>
          <div id="destinationSuggestions" class="destination-suggestions" style="display: none;"></div>
        </div>
        <span class="error" id="error-destination">
          {% if form.destination.errors %}{{ form.destination.errors }}{% endif %}
        </span>

        <label for="{{ form.transport_type.id_for_label }}">Transportation Type</label>
        {{ form.transport_type }}
        <span class="error" id="error-transport-type">
          {% if form.transport_type.errors %}{{ form.transport_type.errors }}{% endif %}
        </span>

        <div class="form-actions" style="margin-top: 10px;">
          
          <button type="submit" class="btn primary" id="navigateBtn">
            <i class="fa-solid fa-route"></i> Navigate Route
          </button>
        </div>

        <div id="fareDisplay">
          <label>Estimated Fare:</label>
          <p id="calculatedFare">
            {% if calculated_fare is not None %}
              Php {{ calculated_fare|floatformat:2 }}
            {% else %}
              Php 0.00
            {% endif %}
          </p>
        </div>

        {# Hidden fields for backend calculation and saving #}
        <input type="hidden" name="fare" id="id_fare" value="{{ calculated_fare|default:'0.00' }}">
        <input type="hidden" name="distance_km" id="id_distance_km" value="{{ calculated_distance|default:'' }}">
        <input type="hidden" name="travel_time_minutes" id="id_travel_time_minutes" value="{{ calculated_time|default:'' }}">
        
        <input type="hidden" name="origin_latitude" id="id_origin_latitude" value="{{ get_origin_lat|default:'' }}">
        <input type="hidden" name="origin_longitude" id="id_origin_longitude" value="{{ get_origin_lon|default:'' }}">
        <input type="hidden" name="destination_latitude" id="id_destination_latitude" value="{{ get_dest_lat|default:'' }}">
        <input type="hidden" name="destination_longitude" id="id_destination_longitude" value="{{ get_dest_lon|default:'' }}">

        <label for="{{ form.notes.id_for_label }}">Additional Notes (Optional)</label>
        {{ form.notes }}
        <span class="error" id="error-notes">
          {% if form.notes.errors %}{{ form.notes.errors }}{% endif %}
        </span>

        {# Server-side success/error messages #}
        {% if success_message %}
          <p class="success-message">{{ success_message }}</p>
        {% endif %}
        {% if error_message %}
          <p class="error-message">{{ error_message }}</p>
        {% endif %}

        {% if user.is_authenticated %}
          <button type="button" id="saveMyRouteBtn" class="btn primary" {% if not calculated_distance %}disabled{% endif %}>
            <i class="fa-solid fa-heart"></i> Save My Route
          </button>
        {% else %}
          <button type="button" class="btn primary" disabled title="Unavailable in Guest Mode">
            <i class="fa-solid fa-heart"></i> Save My Route
          </button>
        {% endif %}
      </form>

      {% if user.is_authenticated %}
      <div class="saved-locations">
        <h4><i class="fa-solid fa-star"></i> My Saved Routes</h4>
        <p style="font-size: 12px; color: #666;">Your frequently used routes</p>
        <ul id="savedList">
          {% if saved_routes %}
            {% for saved in saved_routes %}
              <li class="saved-route-item">
                <div class="saved-route-info">
                  <strong>
                    {% if saved.transport_type == 'Jeepney' and saved.code %}
                      <i class="fa-solid fa-bus"></i> {{ saved.code }}
                    {% elif saved.transport_type == 'Taxi' %}
                      <i class="fa-solid fa-car"></i> Taxi
                    {% elif saved.transport_type == 'Motorcycle' %}
                      <i class="fa-solid fa-motorcycle"></i> Motorcycle
                    {% else %}
                      <i class="fa-solid fa-bus"></i> {{ saved.transport_type }}
                    {% endif %}
                  </strong>
                  <p style="margin: 3px 0; font-size: 12px;">{{ saved.origin }} ‚Üí {{ saved.destination }}</p>
                  <p style="margin: 0; font-size: 11px; color: #4CAF50;">Php {{ saved.fare|floatformat:2 }}</p>
                </div>
                <div class="saved-route-actions">
                  <div class="saved-route-actions">
                    <button type="button" class="btn btn-sm view-saved-route" 
                        style="flex: 1; background-color: #2196F3; color: white;"
                        data-route-id="{{ saved.id }}"
                        data-path="{{ saved.route_path_coords|escapejs }}"
                        data-origin-lat="{{ saved.origin_latitude }}"
                        data-origin-lon="{{ saved.origin_longitude }}"
                        data-dest-lat="{{ saved.destination_latitude }}"
                        data-dest-lon="{{ saved.destination_longitude }}"
                        data-route-origin="{{ saved.origin }}"
                        data-route-destination="{{ saved.destination }}"
                        title="View on map">
                        <i class="fa-solid fa-map"></i> View
                    </button>
                    
                    <button type="button" class="btn btn-sm delete-saved-route" 
                            style="flex: 1; background-color: #dc3545; color: white;"
                            data-saved-id="{{ saved.id }}"
                            title="Delete">
                      <i class="fa-solid fa-trash"></i> Delete
                    </button>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li style="color: #999; font-style: italic;">No saved routes yet</li>
          {% endif %}
        </ul>
      </div>
      {% endif %} </aside>

    <main class="map-area">
      <div id="map-loader" class="loader">
        Loading map...
      </div>

      <div id="map-container">
        {{ map|safe }}
      </div>
    </main>

    <aside class="suggestions">
      <h3><i class="fa-solid fa-lightbulb"></i> Jeepney Route Suggestions</h3>
      <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Community-contributed jeepney routes</p>

      <div id="dynamicSuggestions">
        {% if all_routes %}
          {% for route in all_routes %}
            {# Only show Jeepney routes in suggestions #}
            {% if route.transport_type == 'Jeepney' %}
              <div class="journey-card {% if route.id|stringformat:'s' == highlight_route_id %}highlighted-route{% endif %}">
                <div class="journey-header">
                  <div class="journey-route-summary">
                    <span class="segment jeepney-segment">
                      <i class="fa-solid fa-bus"></i> {{ route.code|default:'N/A' }}
                    </span>
                  </div>
                  <div class="journey-time">
                    {% if route.travel_time_minutes %}{{ route.travel_time_minutes|floatformat:0 }} min{% else %}N/A{% endif %}
                  </div>
                </div>
                <div class="journey-details">
                  <p class="journey-schedule"><strong>From:</strong> {{ route.origin }}</p>
                  <p class="journey-schedule"><strong>To:</strong> {{ route.destination }}</p>
                  <p class="journey-fare">Est. Fare: Php {{ route.fare|floatformat:2 }}</p>
                  {% if route.distance_km %}<p class="journey-distance">{{ route.distance_km|floatformat:1 }} km</p>{% endif %}
                  {% if route.notes %}
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                      <i class="fa-solid fa-comment"></i> {{ route.notes|truncatewords:15 }}
                    </p>
                  {% endif %}
                </div>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                  <!-- <button type="button" class="btn btn-sm view-journey-on-map-btn" style="flex: 1; background-color: #2196F3; color: white;"
                          data-route-id="{{ route.id }}"
                          data-origin-lat="{{ route.origin_latitude }}"
                          data-origin-lon="{{ route.origin_longitude }}"
                          data-dest-lat="{{ route.destination_latitude }}"
                          data-dest-lon="{{ route.destination_longitude }}"
                          data-route-code="{{ route.code }}"
                          data-transport-type="{{ route.transport_type }}"
                          data-route-origin="{{ route.origin }}"
                          data-route-destination="{{ route.destination }}"
                          onclick="window.location.href='?route_id={{ route.id }}'"
                          title="View this route on the map">
                    <i class="fa-solid fa-map"></i> View Route
                  </button> -->
                  <!-- Change route to use path coordinates for more accurate display -->
                  <button type="button" class="btn btn-sm view-suggested-route" style="flex: 1; background-color: #2196F3; color: white;"
                      data-route-id="{{ route.id }}"
                      data-path="{{ route.route_path_coords|escapejs }}"
                      data-origin-lat="{{ route.origin_latitude }}"
                      data-origin-lon="{{ route.origin_longitude }}"
                      data-dest-lat="{{ route.destination_latitude }}"
                      data-dest-lon="{{ route.destination_longitude }}"
                      data-route-origin="{{ route.origin }}"
                      data-route-destination="{{ route.destination }}"
                      title="View this route on the map">
                      <i class="fa-solid fa-map"></i> View Route
                  </button>

                    {% if user.is_authenticated %}
                    <button type="button" class="btn btn-sm save-suggested-route" 
                            style="flex: 1; background-color: #4CAF50; color: white;"
                            data-route-id="{{ route.id }}"
                            title="Save this route to your favorites">
                      <i class="fa-solid fa-heart"></i> Save
                    </button>
                    {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="journey-card">
            <p style="text-align: center; color: #999;">
              <i class="fa-solid fa-info-circle"></i><br>
              No jeepney route suggestions yet.<br>
              Be the first to contribute!
            </p>
          </div>
        {% endif %}
      </div>

      <hr style="margin: 20px 0;">

      <h4><i class="fa-solid fa-share-nodes"></i> Suggest a Jeepney Route</h4>
      {% if user.is_authenticated %}
        <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
          Help others by sharing jeepney routes you know
        </p>
        <form id="suggestRouteForm" method="post" action="{% url 'suggest_route' %}">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="suggest_route">
          <input type="hidden" name="transport_type" value="Jeepney">
          
          <label for="suggest_origin">Route Origin</label>
          <input type="text" name="origin" id="suggest_origin" 
                 placeholder="e.g., SM City Cebu" 
                 class="form-control" required>
          
          <label for="suggest_destination">Route Destination</label>
          <input type="text" name="destination" id="suggest_destination" 
                 placeholder="e.g., Ayala Center" 
                 class="form-control" required>
          
          <label for="suggest_code">Jeepney Code</label>
          <select name="code" id="suggest_code" class="form-control" required>
            <option value="">Select jeepney code</option>
            {% for code_value, code_label in suggestion_form.code.field.choices %}
              <option value="{{ code_value }}">{{ code_label }}</option>
            {% endfor %}
          </select>
          
          <label for="suggest_notes">Route Details (Optional)</label>
          <textarea name="notes" id="suggest_notes" 
                    placeholder="Additional info about this route..." 
                    rows="3" class="form-control"></textarea>
          
          <button type="submit" class="btn primary">
            <i class="fa-solid fa-paper-plane"></i> Submit Suggestion
          </button>
        </form>
      {% else %}
        <div class="guest-restriction-notice">
          <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
            You must have an account to suggest a route.
          </p>
          <button type="button" class="btn primary" disabled title="Unavailable in Guest Mode">
            <i class="fa-solid fa-paper-plane"></i> Submit Suggestion
          </button>
        </div>
      {% endif %}
    </aside>

  </div>

  <script src="{% static 'route_input/js/script.js' %}"></script>
</body>
</html>